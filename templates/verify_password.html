{% extends "layout.html" %}

{% block title %}Identity Verification{% endblock %}

{% block head %}
<style>
    /* Disable context menu */
    body {
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
        user-select: none;
    }
</style>
<script>
    document.addEventListener('contextmenu', event => event.preventDefault());
</script>
{% endblock %}

{% block content %}
<div class="secure-container" style="display:none;" id="mainContainer">
    <div id="camView" title="Environment Scan Active"></div>

    <div class="cyber-card" style="max-width: 400px; margin: 0 auto;">
        <h2 style="color:var(--error); text-align: center; margin-bottom: 2rem;">[ ACCESS_CONTROL ]</h2>

        <p style="text-align: center; color: var(--text-muted); margin-bottom: 2rem;">
            This file is protected by a multi-layer encryption protocol.
            Enter your credentials to decrypt securely in-memory.
        </p>

        <form method="POST">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="input-group">
                <label>DECRYPTION_KEY (PASSWORD)</label>
                <div style="position:relative;">
                    <input type="password" name="password" required autofocus placeholder=">_"
                        style="letter-spacing: 2px;">
                </div>
            </div>

            <button type="submit" class="btn btn-block" style="border-color:var(--error); color:var(--error);">
                [ AUTHENTICATE ]
            </button>
        </form>

        <div style="margin-top: 1.5rem; font-size: 0.8rem; color: #555; text-align: center;">
            Warning: 3 failed attempts will permanently lock this file.
            <br>Access events are logged and monitored.
        </div>
    </div>
</div>

<div id="prepScreen"
    style="height: 60vh; display:flex; flex-direction:column; justify-content:center; align-items:center; text-align:center;">
    <div class="animate-pulse"
        style="color: var(--primary); font-family:var(--font-mono); font-size:1.2rem; margin-bottom:20px;">
        [ SECURITY_CHECK_REQUIRED ]
    </div>
    <p style="color: var(--text-muted); max-width:300px; margin-bottom: 20px;">
        This file requires a secure environment. Please grant camera access to verify execution integrity.
    </p>
    <button
        onclick="SecurityMonitor.initCamera(); this.style.display='none'; document.getElementById('init_msg').innerText='INITIALIZING HARDWARE...'"
        class="btn" style="border-color: var(--accent); color: var(--accent);">
        [ VERIFY ENVIRONMENT ]
    </button>
    <p id="init_msg" style="margin-top:10px; color:var(--text-muted); font-size:0.8rem;"></p>
</div>

<script src="{{ url_for('static', filename='js/security.js') }}"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // Init config only. User must click button to start camera.
        SecurityMonitor.initVerification(
            "{{ file_id }}",
            "{{ url_for('delete_file', file_id=file_id) }}",
            "{{ url_for('home') }}"
        );

        // Simple poll to show UI once camera is ready
        const checkCam = setInterval(() => {
            if (SecurityMonitor.state.cameraStream && SecurityMonitor.state.cameraStream.active) {
                document.getElementById('prepScreen').style.display = 'none';
                document.getElementById('mainContainer').style.display = 'block';
                clearInterval(checkCam);
            }
        }, 500);
    });
</script>
{% endblock %}